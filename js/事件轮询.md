JavaScript 的事件循环模型与许多其他语言不同的一个非常有趣的特性是，它永不阻塞。

由于历史原因有一些例外，如 alert 或者同步 XHR，但应该尽量避免使用它们。

## 运行时概念

### 栈

函数调用形成了一个由若干帧组成的栈。

### 堆

对象被分配在堆中，堆是一个用来表示一大块（通常是非结构化的）内存区域的计算机术语。

### 队列

一个 JavaScript 运行时包含了一个待处理消息的消息队列。每一个消息都关联着一个用以处理这个消息的回调函数。

在事件循环期间的某个时刻，运行时会从最先进入队列的消息开始处理队列中的消息。
被处理的消息会被移出队列，并作为输入参数来调用与之关联的函数。

函数的处理会一直进行到执行栈再次为空为止，然后事件循环将会处理队列中的下一个消息（如果还有的话）。

setTimeout 的第二个参数代表了消息实际被实际加入到队列的最小延迟时间。

### 多个运行时互相通信

一个 Web Worker 或者一个跨域的 iframe 都有自己的栈、堆和消息队列。
两个不同的运行时只能通过 postMessage 方法进行通信。
如果另一个运行时侦听 message 事件，则此方法会向该运行时添加消息。

## JavaScript 执行上下文

当一段 JavaScript 代码在运行的时候，它实际上是运行在执行上下文中。
下面三种类型的代码会创建一个新的执行上下文：

- 全局上下文是为运行代码主体而创建的执行上下文，也就是说，它是为那些存在于 JavaScript 函数之外的任何代码创建的。
- 每个函数会在运行的时候创建自己的执行上下文。这个上下文就是通常说的“本地上下文”。
- 使用 eval 函数也会创建一个新的执行上下文。

每一个上下文在本质上都是一种作用域层级。
每段代码开始执行的时候都会创建一个新的上下文来运行它，并且在代码退出的时候销毁掉。

## JavaScript 运行时

在执行 JavaScript 代码的时候，JavaScript 运行时实际上维护了一组用于执行 JavaScript 代码的代理。
每个代理由一组执行上下文的集合、执行上下文栈、主线程、一组可能创建用于执行 worker 的额外线程集合、一个任务队列以及一个微任务队列构成。
除了主线程（某些浏览器在多个代理间共享的主线程）之外，其他组成部分对该代理都是唯一的。

### 事件循环

事件循环负责收集事件（包括用户事件以及其他非用户事件等）、对任务进行排队以便在合适的时候执行回调。
然后它执行所有处于等待中的 JavaScript 任务，然后是微任务，然后在开始下一次循环之前执行一些必要的渲染和绘制操作。

### 任务 vs 微任务

一个任务就是指任何由标准机制来执行的任何 JavsScript，如程序的初始化、事件触发的回调等。
除了使用事件，你还可以使用 setTimeout()、setInterval() 或者 setImmediate() 来添加任务。

任务队列和微任务队列的区别很简单，但却很重要：

- 当执行来自任务队列中的任务时，在每一次新的事件循环开始迭代的时候运行时都会执行队列中的每个任务。在每次迭代开始之后加入到队列中的任务需要在下一次迭代开始之后才会被执行。
- 每次当一个任务退出且执行上下文栈为空的时候，微任务队列中的每一个微任务会依次被执行。不同的是它会等到微任务队列为空才会停止执行——即使中途有微任务加入。换句话说，微任务可以添加新的微任务到队列中，这些新的微任务将在下一个任务开始运行之前，在当前循环迭代结束之前执行。

### 任务（Tasks）

在以下时机，任务会被添加到任务队列：

- 一段新程序或子程序被直接执行时（比如从一个控制台，或在一个 `<script>` 元素中运行代码）。
- 触发了一个事件，将其回调函数添加到任务队列时。
- 执行到一个由 setTimeout() 或 setInterval() 创建的 timeout 或 interval，以致相应的回调函数被添加到任务队列时。

### 微任务（Microtasks）

JavsScript 中的 promise 和 Mutation Observer API 都使用微任务队列去运行他们的回调函数。
为了允许第三方库、框架、profill 能使用微任务，在 Window 和 Worker 接口上暴露了 queueMicrotask() 方法。

## 参考

- https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Event_loop
- https://developer.mozilla.org/zh-CN/docs/Web/API/HTML_DOM_API/Microtask_guide/In_depth
