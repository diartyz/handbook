## 概述

用户期待内容快速加载和交互流畅的 Web 体验。

等待加载时间和大部分情况下浏览器单线执行是影响 Web 性能的两大主要原因。

## 导航

### DNS 查询

第一步是要去寻找页面资源的位置，如果以前没有访问过这个网站，就需要进行 DNS 查询。
浏览器向名称服务器发起 DNS 查询请求，最终得到一个 IP 地址。
滴一次请求之后，这个 IP 地址可能会被缓存一段时间，来加速后续的请求。
通过主机名加载一个页面通常仅需要一次 DNS 查询，但是，对于浏览器指向的不同主机名，则需要多次 DNS 查询。

### TCP 握手

一旦获取到服务器 IP 地址，浏览器就会通过 TCP 三次握手与服务器建立连接。
这意味着终端与每台服务器之间还要来回发送三条消息，而请求尚未发出。

### TLS 协商

为了在 HTTPS 上建立安全连接，TLS 协商是必须的。
它决定了什么密码将会被用来加密通信，验证服务器，在进行真实的数据传输之前建立安全连接。
在发送真正的请求内容之前还需要五次往返服务器。

## 响应

一旦我们建立了到 Web 服务器的连接，浏览器就发送一个初始的 HTTP GET 请求，这个请求通常是一个 HTML 文件。
Time to First Bype（TTFB）是用户通过点击链接进行请求与收到第一个 HTML 数据包之间的时间。

### TCP 慢启动 / 14KB 规则

第一个响应数据包是 14KB 大小的，这是慢启动的一部分。
在 TCP 慢启动中，在收到初识包之后，服务器会将下一个数据包的大小加倍到大约 28KB。
后续的数据依次是前一个包大小的 2 倍直到达到预定的阈值，或者遇到拥塞。

### 拥塞控制

当服务器用 TCP 数据包来发送数据时，客户端通过返回确认帧来确认传输。
如果服务器太快地发送太多包，他们可能会被丢弃，将不会有确认帧的返回。
拥塞控制算法使用这个发送包和确认帧流来确定发送速率。

## 解析

一旦浏览器收到数据的第一块，它就可以开始解析收到的信息。
解析是浏览器将通过网络接收的数据转换为 DOM 和 CSSDOM 的步骤，通过渲染器把 DOM 和 CSSDOM 在屏幕上绘制成页面。

即使请求页面的 HTML 大于初始的 14KB 数据包，浏览器也将开始解析并尝试根据其所拥有的数据进行渲染。
这就是为什么在前 14KB 中包含浏览器开始渲染页面所需要的所有内容，或者至少包含页面模版（第一次渲染所需的 CSS 和 HTML）对于 web 性能优化来说是重要的。
但是在渲染到屏幕上面之前，HTML、CSS、JavaScript 必须被解析完成。

### 构建 DOM 树

处理 HTML 标记并构建 DOM 树时，当解析器发现非阻塞资源，例如一张图片，浏览器会请求这些资源并且继续解析。
当遇到一个 CSS 文件时，解析也可以继续进行。
但是对于 `<script>` 标签（特别是没有 async 或者 defer 属性的）会阻塞渲染并停止 HTML 的解析。

### 预加载扫描器

浏览器构建 DOM 树时，这个过程占用了主线程。
预加载扫描器将解析可用的内容并请求高优先级资源，如 CSS、JavaScript 和 web 字体。
它将在后台检索资源，以便在主 HTML 解析器到达请求的资源时，它们可能已经在运行，或者已经被下载。

等待获取 CSS 不会阻塞 HTML 的解析或者下载，但是它确实会阻塞 JavaScript，因为 JavaScript 经常用于查询元素的 CSS 属性。

### 构建 CSSDOM 树

DOM 和 CSSDOM 是两棵树，它们是独立的数据结构。
浏览器将 CSS 规则转换为可以理解和使用的样式映射，遍历 CSS 中的每个规则集，根据 CSS 选择器创建具有父、子和兄弟关系的节点树。

### JavaScript 编译

当 CSS 被解析并创建 CSSDOM 时，其它资源，包括 JavaScript 文件正在下载（借助预加载扫描器）。
脚本被解析为抽象语法树，被传递到解释器中，转成在主线程上执行的字节码。

### 构建辅助功能树

无障碍对象模型（AOM）类似于 DOM 的语义版本，当 DOM 更新时，浏览器会更新辅助功能树。
在构建 AOM 之前，屏幕阅读器无法访问内容。

## 渲染

渲染步骤包括样式、布局、绘制，在某些情况下还包括合成。

### Style

将 DOM 树和 CSSDOM 树组合成一个 Render 树，计算样式树或渲染树从 DOM 树的根开始构建，遍历每个可见节点。

### Layout

布局是确定呈现树中所有节点的宽度、高度和位置，以及确定页面上每个对象的大小和位置的过程。
回流是对页面的任何部分或整个文档的任何后续大小和位置的确定。

### 绘制

包括将元素的每个可视部分绘制到屏幕上，包括文本、颜色、边框、阴影和替换的元素（如按钮和图像）。

### Compositing

当文档的各个部分以不同的层绘制，相互重叠时，必须进行合成。

当页面继续加载资源时，可能发生回流，回流会触发重新绘制和重新组合。
如果我们定义了图像的大小，就不需要重新绘制，只需要重新绘制需要重新绘制的层，并在必要时进行合成。

## 交互

绘制页面完成后，要等待 JavaScript 执行后才能交互。
Time to Interactive（TTI）是测量从第一个请求导致 DNS 查询和 SSL 连接到页面可交互时所用的时间。

## 附录

- https://developer.mozilla.org/zh-CN/docs/Web/Performance/How_browsers_work
